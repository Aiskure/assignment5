# CS336 Assignment 5: Alignment 实验记录

> 课程：Stanford CS336 Spring 2025
> 作业：Assignment 5 - Alignment
> 模型：Qwen 2.5 Math 1.5B
> 数据集：GSM8K（替代 MATH）
> 训练环境：NSCC — 4x NVIDIA A100 40GB per job

---

## Day 1 (2026-02-09) — 环境配置

### 完成的工作

1. **CUDA 12.4 配置**
   - 安装位置：`/scratch/users/nus/e1553316/cuda-12.4`
   - 配置 `~/.bashrc`：设置 `CUDA_HOME`、`PATH`、`LD_LIBRARY_PATH`

2. **Python 依赖安装**
   - `uv sync --no-install-package flash-attn` 安装基础依赖
   - flash-attn 需要 GPU 编译，登录节点无法完成

3. **flash-attn 编译**（在 GPU 计算节点完成）
   - 申请交互式 GPU 节点：`qsub -I -l select=1:ngpus=1 -l walltime=01:00:00`
   - 设置 `TORCH_CUDA_ARCH_LIST="8.0"` (A100)、`MAX_JOBS=4`
   - `uv sync` 编译成功，耗时约 4 分钟
   - flash-attn==2.7.4.post1 安装完成，编译结果持久化在 `.venv/` 中

4. **模型下载**
   - 从 HuggingFace 下载 `Qwen/Qwen2.5-Math-1.5B`
   - 存放位置：`/scratch/users/nus/e1553316/assignment5/models/Qwen2.5-Math-1.5B`
   - 模型文件完整：config.json, model.safetensors, tokenizer.json 等

5. **路径配置**
   - 原作业路径 `/data/a5-alignment/models/` 在 NSCC 上无写权限
   - 修改 `tests/conftest.py` model_id 指向实际模型路径
   - 更新 CLAUDE.md 保持一致

6. **创建项目文档**
   - CLAUDE.md — Claude Code 项目上下文
   - 学习记录.md — 学习笔记
   - 实验记录.md — 本文件

### 当前状态

- [x] CUDA 12.4 配置完成
- [x] Python 依赖安装完成
- [x] flash-attn 编译完成
- [x] 模型下载完成
- [x] 路径配置完成
- [ ] adapters.py 函数实现（0/11 必做 + 0/5 可选）
- [ ] 单元测试通过
- [ ] 训练实验

### 待办

- 开始实现 `tests/adapters.py` 中的函数（Phase 1: SFT, Phase 2: GRPO）
- GSM8K 数据集会在首次使用时自动下载

---

## Day 2 (2026-02-14) — 首次完整评估（Qwen2.5-Math-1.5B on GSM8K test）

### 执行过程

1. **申请单卡交互节点**
   - 命令：`qsub -I -l select=1:ngpus=1:mem=64gb -l walltime=04:00:00`
   - 说明：1 卡 A100 40GB 对 1.5B 模型评估已足够

2. **评估命令修正**
   - 错误写法：`uv python cs336_alignment/math_baseline.py`
   - 正确写法：`uv run python -m cs336_alignment.math_baseline`

3. **数据格式适配**
   - `math_baseline.py` 依赖 `data/gsm8k/test.jsonl`
   - 已补齐并确认可读：`data/gsm8k/test.jsonl`（1319 条）

4. **运行中问题与处理**
   - `SyntaxWarning`（`drgrpo_grader.py` 中 regex 转义）为 warning，不阻塞评估
   - vLLM 在 PBS 环境下遇到 `CUDA_VISIBLE_DEVICES=GPU-UUID` 兼容问题，已在 `math_baseline.py` 增加 UUID -> index 兼容处理

### 评估结果（test split）

- 样本数：`1319`
- Accuracy（reward=1 比例）：`0.0348749052`（约 `3.49%`）
- Format reward：`0.2934040940`（约 `29.34%`）
- Type 统计：
  - Type1（格式正确 + 答案正确）：`46`
  - Type2（格式正确 + 答案错误）：`341`
  - Type3（格式错误）：`932`

### 输出文件

- 结果日志：`/scratch/users/nus/e1553316/assignment5/models/Qwen2.5-Math-1.5B/test_log.json`

### 当前状态更新

- [x] GSM8K test 基线评估已跑通（单卡 vLLM）
- [ ] adapters.py 函数实现（0/11 必做 + 0/5 可选）
- [ ] 单元测试通过
- [ ] 训练实验（SFT/GRPO）

---

## Day 3 (2026-02-16) — SFT 训练跑通 + 周期评估 + W&B 记录

### 完成的工作

1. **SFT 核心训练流程跑通**
   - 在 `cs336_alignment/sft.py` 中完成 micro-batch 训练主循环
   - 启用梯度累积与梯度裁剪：`clip_grad_norm_(..., 1.0)`
   - 训练期间 loss 与 grad_norm 均可持续记录

2. **周期性评估流程跑通（vLLM）**
   - 训练中每 `1000` 个 step 触发一次评估
   - 将当前 checkpoint 保存到 `sft_eval/{step}/`
   - 对 `GSM8K test`（`1319` 条）执行评估并写入 `test_log.json`

3. **完整一次 SFT 实验完成**
   - 总 step：`22410`
   - 评估点：`0, 1000, 2000, ..., 22000`（共 23 个）
   - 已得到完整 accuracy 曲线与 type1/type2/type3 变化曲线

4. **W&B 记录与依赖版本修正**
   - 受集群网络代理影响，采用 `offline` 记录
   - `wandb` 版本固定为 `0.24.2`（`pyproject.toml` + `uv sync`）
   - 离线目录已保存，可后续同步或导出

### 关键结果（本次 full run）

- **最终 accuracy**（step=22000）：`0.3282789992`（约 `32.83%`）
- **最佳 accuracy**（step=18000）：`0.3305534496`（约 `33.06%`）
- **最终类型统计**（step=22000）：
  - Type1（格式正确 + 答案正确）：`433`
  - Type2（格式正确 + 答案错误）：`606`
  - Type3（格式错误）：`280`
- **最终训练指标**（W&B summary）：
  - `train/loss = 1.9609375`
  - `train/grad_norm = 138`
  - 运行时长约 `2776.93s`（约 `46.3` 分钟）

### 结果解读

- accuracy 从基线（约 `3.49%`）显著提升到 `32%+`，已超过题目要求的 `15%`。
- 后期进入平台区间（约 `31%~33%` 波动），主要瓶颈从“格式错误”转为“格式正确但答案错误”（Type2 偏高）。

### 输出文件

- 周期评估日志：
  - `sft_eval/*/test_log.json`
  - `cs336_alignment/sft_eval/*/test_log.json`
- W&B 离线 run：
  - `wandb/offline-run-20260216_001131-259v26t8`
  - `wandb/offline-run-20260216_001131-259v26t8/files/wandb-summary.json`
- 曲线截图：
  - `assert/sft_experiment/accuracy.png`
  - `assert/sft_experiment/loss.png`
  - `assert/sft_experiment/grad_norm.png`
  - `assert/sft_experiment/type1.png`
  - `assert/sft_experiment/type2.png`
  - `assert/sft_experiment/type3.png`

### 当前状态更新

- [x] GSM8K baseline 评估
- [x] SFT 训练流程跑通（含周期评估）
- [x] 达到 >15% 验证准确率目标
- [ ] 多数据规模对比实验（128/256/512/1024/full）
- [ ] 过滤正确样本后的第二组 SFT 对比实验
